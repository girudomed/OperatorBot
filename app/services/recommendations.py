# –§–∞–π–ª: app/services/recommendations.py

"""
–°–µ—Ä–≤–∏—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º —á–µ—Ä–µ–∑ LLM.
–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–≤–æ–Ω–∫–∏ –∏ —Å–æ–∑–¥–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
"""

from typing import List, Dict, Any, Optional
from datetime import date

from app.logging_config import get_watchdog_logger

logger = get_watchdog_logger(__name__)


class RecommendationsService:
    """–°–µ—Ä–≤–∏—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤."""
    
    def __init__(self, llm_client=None):
        """
        Args:
            llm_client: –ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å LLM (GPT-4, Claude –∏ —Ç.–¥.)
                       –ï—Å–ª–∏ None, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∑–∞–≥–ª—É—à–∫–∞
        """
        self.llm_client = llm_client
    
    async def generate_operator_recommendations(
        self,
        operator_name: str,
        calls_data: List[Dict[str, Any]],
        stats: Optional[Dict[str, Any]] = None
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∑–≤–æ–Ω–∫–æ–≤.
        
        Args:
            operator_name: –ò–º—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
            calls_data: –°–ø–∏—Å–æ–∫ –∑–≤–æ–Ω–∫–æ–≤ —Å –ø–æ–ª—è–º–∏:
                - transcript: —Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
                - call_score: –æ—Ü–µ–Ω–∫–∞ 
                - call_category: –∫–∞—Ç–µ–≥–æ—Ä–∏—è
                - outcome: —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                - refusal_reason: –ø—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞
            stats: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥
        
        Returns:
            –¢–µ–∫—Å—Ç —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
        """
        if not calls_data:
            return "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –ù–µ—Ç –∑–≤–æ–Ω–∫–æ–≤ –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π."
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è LLM
        prompt = self._build_recommendations_prompt(operator_name, calls_data, stats)
        
        # –ï—Å–ª–∏ LLM –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        if not self.llm_client:
            return self._generate_fallback_recommendations(calls_data, stats)
        
        try:
            # –í—ã–∑–æ–≤ LLM (–∑–∞–≥–ª—É—à–∫–∞, –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –≤—ã–∑–æ–≤)
            # recommendations = await self.llm_client.generate(prompt)
            recommendations = self._generate_fallback_recommendations(calls_data, stats)
            return recommendations
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —á–µ—Ä–µ–∑ LLM: {e}")
            return self._generate_fallback_recommendations(calls_data, stats)
    
    def _build_recommendations_prompt(
        self,
        operator_name: str,
        calls_data: List[Dict[str, Any]],
        stats: Optional[Dict[str, Any]]
    ) -> str:
        """–§–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è LLM."""
        
        prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –æ–±—É—á–µ–Ω–∏—é –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ call-—Ü–µ–Ω—Ç—Ä–∞. 
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–∞–±–æ—Ç—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ {operator_name} –∏ –¥–∞–π 3-5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ —É–ª—É—á—à–µ–Ω–∏—é.

–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥:
"""
        
        if stats:
            prompt += f"""
- –í—Å–µ–≥–æ –∑–≤–æ–Ω–∫–æ–≤: {stats.get('accepted_calls', 0)}
- –ó–∞–ø–∏—Å–µ–π: {stats.get('records', 0)}
- –ö–æ–Ω–≤–µ—Ä—Å–∏—è: {stats.get('conversion_rate', 0)}%
- –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: {stats.get('avg_score_all', 0)}/10
- –ó–≤–æ–Ω–∫–æ–≤ —Å –∂–∞–ª–æ–±–∞–º–∏: {stats.get('complaint_calls', 0)}
"""
        
        prompt += f"\n\n–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤ ({len(calls_data)} —à—Ç.):\n\n"
        
        for i, call in enumerate(calls_data[:5], 1):
            prompt += f"""
### –ó–≤–æ–Ω–æ–∫ {i}
- –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {call.get('call_category', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}
- –û—Ü–µ–Ω–∫–∞: {call.get('call_score', '–ù–µ—Ç')}/10
- –†–µ–∑—É–ª—å—Ç–∞—Ç: {call.get('outcome', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}
- –ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞: {call.get('refusal_reason', '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}
- –§—Ä–∞–≥–º–µ–Ω—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞:
{self._truncate_transcript(call.get('transcript', ''))}

"""
        
        prompt += """
–ù–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. –ü–æ —Ç–µ—Ö–Ω–∏–∫–µ –ø—Ä–æ–¥–∞–∂ –∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏–∏
2. –ü–æ —Ä–∞–±–æ—Ç–µ —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è–º–∏
3. –ü–æ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º—É —Ç–æ–Ω—É –∏ —ç–º–ø–∞—Ç–∏–∏
4. –ü–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ä–µ—á–µ–≤—ã–º –º–æ–¥—É–ª—è–º

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –∏ –ø—Ä–∏–º–µ–Ω–∏–º—ã–º–∏
- –û—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö –∏–∑ –∑–≤–æ–Ω–∫–æ–≤
- –° —É–∫–∞–∑–∞–Ω–∏–µ–º, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –ø–æ-–¥—Ä—É–≥–æ–º—É
"""
        
        return prompt
    
    def _truncate_transcript(self, transcript: str, max_length: int = 500) -> str:
        """–û–±—Ä–µ–∑–∞–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞."""
        if not transcript:
            return "[–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç]"
        
        if len(transcript) <= max_length:
            return transcript
        
        return transcript[:max_length] + "... [–æ–±—Ä–µ–∑–∞–Ω–æ]"
    
    def _generate_fallback_recommendations(
        self,
        calls_data: List[Dict[str, Any]],
        stats: Optional[Dict[str, Any]]
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –±–∞–∑–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –±–µ–∑ LLM –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.
        Fallback –¥–ª—è —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ LLM –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.
        """
        recommendations = []
        
        # –ê–Ω–∞–ª–∏–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        if stats:
            conversion_rate = stats.get('conversion_rate', 0)
            avg_score = stats.get('avg_score_all', 0)
            complaint_calls = stats.get('complaint_calls', 0)
            
            # –ù–∏–∑–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è
            if conversion_rate < 30:
                recommendations.append(
                    "üìâ **–ù–∏–∑–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –∑–∞–ø–∏—Å—å ({}%)**\n"
                    "- –ë–æ–ª—å—à–µ —É–∑–Ω–∞–≤–∞–π—Ç–µ –æ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è—Ö –∫–ª–∏–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º —É—Å–ª—É–≥–∏\n"
                    "- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É \"–î–∞-–¥–∞-–¥–∞\" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–∏—è\n"
                    "- –ù–µ —Ç–æ—Ä–æ–ø–∏—Ç–µ—Å—å —Å –∑–∞–ø–∏—Å—å—é, —Å–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ü–µ–Ω–Ω–æ—Å—Ç—å".format(conversion_rate)
                )
            
            # –ù–∏–∑–∫–∞—è —Å—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞
            if avg_score < 7:
                recommendations.append(
                    "‚≠êÔ∏è **–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ –Ω–∏–∂–µ –Ω–æ—Ä–º—ã ({}/10)**\n"
                    "- –†–∞–±–æ—Ç–∞–π—Ç–µ –Ω–∞–¥ –≤–µ–∂–ª–∏–≤–æ—Å—Ç—å—é –∏ —ç–º–ø–∞—Ç–∏–µ–π –≤ –Ω–∞—á–∞–ª–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞\n"
                    "- –ê–∫—Ç–∏–≤–Ω–æ —Å–ª—É—à–∞–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞, –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É–π—Ç–µ –µ–≥–æ –∑–∞–ø—Ä–æ—Å—ã\n"
                    "- –ò–∑–±–µ–≥–∞–π—Ç–µ —à–∞–±–ª–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑, –±—É–¥—å—Ç–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–µ–µ".format(round(avg_score, 1))
                )
            
            # –ï—Å—Ç—å –∂–∞–ª–æ–±—ã
            if complaint_calls > 0:
                recommendations.append(
                    f"‚ö†Ô∏è **–ñ–∞–ª–æ–±—ã ({complaint_calls} —à—Ç.)**\n"
                    "- –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –∏ —ç–º–ø–∞—Ç–∏—é\n"
                    "- –ò–∑–≤–∏–Ω–∏—Ç–µ—Å—å –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –≤–∞—à–∞ –≤–∏–Ω–∞\n"
                    "- –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã"
                )
        
        # –ê–Ω–∞–ª–∏–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–≤–æ–Ω–∫–æ–≤
        low_score_calls = [c for c in calls_data if c.get('call_score', 10) < 6]
        refusal_calls = [c for c in calls_data if c.get('refusal_reason')]
        
        if low_score_calls:
            recommendations.append(
                f"üéØ **–ó–≤–æ–Ω–∫–∏ —Å –Ω–∏–∑–∫–æ–π –æ—Ü–µ–Ω–∫–æ–π ({len(low_score_calls)} —à—Ç.)**\n"
                "- –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∑–∞–ø–∏—Å–∏ —ç—Ç–∏—Ö –∑–≤–æ–Ω–∫–æ–≤\n"
                "- –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ç–æ–Ω –≥–æ–ª–æ—Å–∞ –∏ —Ç–µ–º–ø —Ä–µ—á–∏\n"
                "- –í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≤ –≥–æ–ª–æ—Å–µ"
            )
        
        if refusal_calls:
            # –°–æ–±–∏—Ä–∞–µ–º —á–∞—Å—Ç—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–∞–∑–∞
            reasons = [c.get('refusal_reason') for c in refusal_calls if c.get('refusal_reason')]
            if reasons:
                recommendations.append(
                    f"‚ùå **–ß–∞—Å—Ç—ã–µ –æ—Ç–∫–∞–∑—ã ({len(refusal_calls)} —à—Ç.)**\n"
                    f"- –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã: {', '.join(set(reasons[:3]))}\n"
                    "- –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –∫–æ–Ω—Ç—Ä–∞—Ä–≥—É–º–µ–Ω—Ç—ã –Ω–∞ —Ç–∏–ø–æ–≤—ã–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è\n"
                    "- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É \"–ß—É–≤—Å—Ç–≤—É—é-–ü–æ–Ω—è–ª-–ù–∞—à–µ–ª\""
                )
        
        # –ï—Å–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–µ—Ç, –¥–∞—Ç—å –æ–±—â–∏–µ
        if not recommendations:
            recommendations.append(
                "‚úÖ **–†–∞–±–æ—Ç–∞ –Ω–∞ —Ö–æ—Ä–æ—à–µ–º —É—Ä–æ–≤–Ω–µ**\n"
                "- –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ\n"
                "- –ü—Ä–æ–±—É–π—Ç–µ –Ω–æ–≤—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –ø—Ä–æ–¥–∞–∂\n"
                "- –î–µ–ª–∏—Ç–µ—Å—å –æ–ø—ã—Ç–æ–º —Å –∫–æ–ª–ª–µ–≥–∞–º–∏"
            )
        
        return "\n\n".join(recommendations)
    
    def format_recommendations_for_telegram(
        self,
        recommendations: str,
        operator_name: str,
        period_str: str
    ) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Telegram."""
        
        header = f"""
üí° <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è {operator_name}</b>
üìÖ –ü–µ—Ä–∏–æ–¥: {period_str}

"""
        
        footer = """

<i>–≠—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ –≤–∞—à–∏—Ö –∑–≤–æ–Ω–∫–æ–≤.
–ü—Ä–æ—Å–ª—É—à–∞–π—Ç–µ –∑–∞–ø–∏—Å–∏ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è.</i>
"""
        
        return header + recommendations + footer
