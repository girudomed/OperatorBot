from typing import Tuple, Optional
import logging

from telegram import Update
from telegram.ext import ContextTypes, CallbackQueryHandler

from app.telegram.utils.callback_data import AdminCB
from app.logging_config import get_watchdog_logger

logger = get_watchdog_logger(__name__)

class LegacyCallbackAdapter:
    """
    –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –ª–µ–≥–∞—Å–∏ callback-–æ–≤ (–ø—Ä–µ—Ñ–∏–∫—Å—ã admin:, admincmd:).
    –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–ª–∞–≤–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ –µ–¥–∏–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª adm:*.
    """
    
    @staticmethod
    async def handle_legacy(update: Update, context: ContextTypes.DEFAULT_TYPE):
        query = update.callback_query
        if not query:
            return

        data = query.data
        if not data:
            return

        # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–µ–≥–∞—Å–∏
        user = update.effective_user
        logger.warning(
            "LEGACY CALLBACK INTERCEPTED: %s (User: %s)",
            data,
            user.id if user else "unknown",
            extra={
                "legacy_data": data,
                "user_id": user.id if user else None
            }
        )

        # –ü—ã—Ç–∞–µ–º—Å—è –º–∞–ø–ø–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –≤ –Ω–æ–≤—ã–µ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –Ω–æ–≤—ã–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã
        # –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ, —Ç–∞–∫ –∫–∞–∫ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–∞, 
        # –Ω–∞–º –Ω—É–∂–Ω–æ –ø–æ–Ω—è—Ç—å, –ö–£–î–ê –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å.
        
        # –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞—Ä—ã–π –ø—Ä–µ—Ñ–∏–∫—Å 'admin:', —Ç–æ —á–∞—Å—Ç–æ –æ–Ω –º–∞–ø–∏—Ç—Å—è –ø—Ä—è–º–æ –≤ 'adm:'
        # –ù–∞–ø—Ä–∏–º–µ—Ä: 'admin:users:list' -> 'adm:usr:lst' (–Ω—É–∂–Ω–æ –ø—Ä–∞–≤–∏–ª–æ –º–∞–ø–ø–∏–Ω–≥–∞)
        
        # –ù–û! –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –º–∏–≥—Ä–∞—Ü–∏–∏, –æ–ø–∏—Å–∞–Ω–Ω—ã–π –≤ –ø–ª–∞–Ω–µ:
        # "–ª–æ–≤–∏—Ç ^admin:, –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –≤ adm:*, –≤—ã–∑—ã–≤–∞–µ—Ç —Ç–æ—Ç –∂–µ –∫–æ–¥"
        # –≠–¢–û –°–õ–û–ñ–ù–û, –¢–ê–ö –ö–ê–ö –ù–£–ñ–ù–û –ó–ù–ê–¢–¨ –§–£–ù–ö–¶–ò–Æ –ù–û–í–û–ì–û –•–ï–ù–î–õ–ï–†–ê.
        
        # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –ü—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—á–∞–µ–º "–û–±–Ω–æ–≤–∏—Ç–µ –º–µ–Ω—é" –µ—Å–ª–∏ –º–∞–ø–ø–∏–Ω–≥ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω,
        # –ò–õ–ò (–ª—É—á—à–µ) –¥–µ–ª–∞–µ–º redirect –Ω–∞ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω–∫–∏.
        
        # –ü–æ—Å–∫–æ–ª—å–∫—É –º—ã –Ω–µ –º–æ–∂–µ–º –ª–µ–≥–∫–æ –≤—ã–∑–≤–∞—Ç—å bound method –¥—Ä—É–≥–æ–≥–æ –∫–ª–∞—Å—Å–∞ –±–µ–∑ –∏–Ω—Å—Ç–∞–Ω—Å–∞,
        # –º—ã –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ —É–≤–µ–¥–æ–º–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ—Ç–ø—Ä–∞–≤–∏–º –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.
        
        await query.answer("–û–±–Ω–∞—Ä—É–∂–µ–Ω —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —ç–ª–µ–º–µ–Ω—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...", show_alert=True)
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π callback –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        # –ù–æ –º—ã –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ—Å—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å query.data –∏ —Ä–µ—Ç—Ä–∞–π–Ω—É—Ç—å –∞–ø–¥–µ–π—Ç –≤–Ω—É—Ç—Ä–∏ PTB –ª–µ–≥–∫–æ.
        # –ü–æ—ç—Ç–æ–º—É –º—ã –ø—Ä–æ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω–∫–∏.
        
        # –ù–æ –ª—É—á—à–µ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–ø–∞—Å—Ç–∏ —Å–∏—Ç—É–∞—Ü–∏—é –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —á–∞—Å—Ç—ã—Ö –∫–µ–π—Å–æ–≤.
        
        # –í–†–ï–ú–ï–ù–ù–û–ï –†–ï–®–ï–ù–ò–ï –°–û–ì–õ–ê–°–ù–û –ü–õ–ê–ù–£:
        # –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º. –•–µ–Ω–¥–ª–µ—Ä—ã –ª–µ–≥–∞—Å–∏ (–µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –µ—Å—Ç—å) –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã
        # –ü–û–°–õ–ï —ç—Ç–æ–≥–æ –∞–¥–∞–ø—Ç–µ—Ä–∞ –∏–ª–∏ –í–ú–ï–°–¢–û –Ω–µ–≥–æ.
        # –ù–æ –∑–∞–¥–∞—á–∞ —Å—Ç–æ–∏—Ç: –ü–û–ô–ú–ê–¢–¨ –∏ –û–ë–†–ê–ë–û–¢–ê–¢–¨.
        
        # –†–∞–∑ –º—ã –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ adm:*, —Ç–æ 'admin:' —É–∂–µ –Ω–∏–∫–µ–º –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è (–º—ã —É–¥–∞–ª–∏–º —Å—Ç–∞—Ä—ã–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã –∏–ª–∏ –æ–Ω–∏ –Ω–µ –±—É–¥—É—Ç –ª–æ–≤–∏—Ç—å).
        # –ó–Ω–∞—á–∏—Ç, –∑–¥–µ—Å—å –º—ã –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        
        # –°–∞–º–æ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ - –≤–µ—Ä–Ω—É—Ç—å –≤ –∫–æ—Ä–µ–Ω—å –∞–¥–º–∏–Ω–∫–∏.
        from app.telegram.utils.callback_data import AdminCB
        
        # –ú—ã –Ω–µ –∏–º–µ–µ–º –¥–æ—Å—Ç—É–ø–∞ –∫ AdminPanelHandler –∑–¥–µ—Å—å. 
        # –ü–æ—ç—Ç–æ–º—É –º—ã –ø—Ä–æ—Å—Ç–æ —Å–∫–∞–∂–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞–∂–∞—Ç—å /admin –∏–ª–∏ –≤–µ—Ä–Ω–µ–º –∫–Ω–æ–ø–∫—É.
        
        from telegram import InlineKeyboardMarkup, InlineKeyboardButton
        
        await query.message.reply_text(
            "‚ö†Ô∏è –í—ã –Ω–∞–∂–∞–ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –º–µ–Ω—é –∑–∞–Ω–æ–≤–æ.",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üëë –û—Ç–∫—Ä—ã—Ç—å –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data=AdminCB.create(AdminCB.DASHBOARD))]
            ])
        )

    @staticmethod
    def get_handler():
        # –õ–æ–≤–∏—Ç –≤—Å–µ, —á—Ç–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å admin: –∏–ª–∏ admincmd:
        pattern = r"^(admin|admincmd):"
        return CallbackQueryHandler(LegacyCallbackAdapter.handle_legacy, pattern=pattern)
