<!-- –§–∞–π–ª: –∞–¥–º–∏–Ω–∫–∞ -->

# üìö –ê–¥–º–∏–Ω–∫–∞ OperatorBot ‚Äî –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

–î–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç, –∫–∞–∫ –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –∞–¥–º–∏–Ω—Å–∫–∞—è —á–∞—Å—Ç—å –±–æ—Ç–∞ –≤ **–Ω–∞—à–µ–º** –ø—Ä–æ–µ–∫—Ç–µ Operabot. –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Äî Telegram, –¥–∞–Ω–Ω—ã–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `users` —Ä–∞–±–æ—á–µ–π –ë–î –∏ —Å–µ—Ä–≤–∏—Å–æ–≤ `app/services/*`. –ù–∏–∂–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –ø–æ—Ç–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤, –∞ —Ç–∞–∫–∂–µ –ø–ª–∞–Ω –¥–æ—Ä–∞–±–æ—Ç–æ–∫.

---

## 1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –º–æ–¥—É–ª–∏

| –ë–ª–æ–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ö–æ–¥ |
|------|------------|-----|
| Telegram-–±–æ—Ç | –æ—Å–Ω–æ–≤–Ω–æ–π UI –¥–ª—è –∞–¥–º–∏–Ω–æ–≤/—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–π; –≤—ã–¥–∞—ë—Ç —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏, –º–µ—Ç—Ä–∏–∫–∏, —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∞–º–∏ | `app/telegram/handlers/*`, `app/telegram/middlewares/permissions.py` |
| Call Lookup | –ø–æ–∏—Å–∫ –∑–≤–æ–Ω–∫–æ–≤ –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–æ–∫ –ø–æ –Ω–æ–º–µ—Ä—É, –≤—ã–¥–∞—á–∞ –∑–∞–ø–∏—Å–∏ | `app/services/call_lookup.py`, `app/telegram/handlers/call_lookup.py` |
| –ú–µ—Ç—Ä–∏–∫–∏/–æ—Ç—á—ë—Ç—ã | –∞–≥—Ä–µ–≥–∞—Ç—ã –ø–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º –∏ LM-–º–µ—Ç—Ä–∏–∫–∏ | `app/services/metrics_service.py`, `app/services/lm_service.py`, `app/services/reports.py` |
| –ë–î Users | —Ö—Ä–∞–Ω–∏—Ç —Å—Ç–∞—Ç—É—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Ä–æ–ª–∏, —Å–≤—è–∑–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä ‚Üî Telegram | `app/db/repositories/operators.py`, —Ç–∞–±–ª–∏—Ü–∞ `users` |

–í–µ–±-–ø–∞–Ω–µ–ª—å —Å QR-–∫–æ–¥–∞–º–∏ –Ω–∞–º –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è ‚Äî –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ Telegram.

---

## 2. –†–æ–ª–∏, —Å—Ç–∞—Ç—É—Å—ã –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø—Ä–∞–≤

–í—Å–µ –ø—Ä–∞–≤–∞ –±–µ—Ä—É—Ç—Å—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `users`. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –ø–æ–ª–µ–π:

- `telegram_id`
- `role`: `operator` | `admin` | `superadmin`
- `status`: `pending` | `approved` | `blocked`
- `full_name`, `extension`, `organization`

### –ü—Ä–∞–≤–∏–ª–∞
1. **–ê–¥–º–∏–Ω—ã –∏–∑ –ë–î.** –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–π —á–∏—Ç–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –∏–∑ `users` (`role in ('admin','superadmin')`).
2. **–ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è.** –õ—é–±–æ–π –¥–µ–π—Å—Ç–≤—É—é—â–∏–π –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–æ–≤–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏–ª–∏ –ø–æ–≤—ã—Å–∏—Ç—å –¥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (—Å–º. ¬ß4).
3. **–í–µ—Ä—Ö–æ–≤–Ω—ã–π –∞–¥–º–∏–Ω.** –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞—ë–º `SUPREME_ADMIN_USERNAME` –∏–ª–∏ `SUPREME_ADMIN_ID` –≤ –∫–æ–Ω—Ñ–∏–≥–µ. –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç:
   - –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–ª–∏ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞ –¥–∞–∂–µ –ø—Ä–∏ –ø—É—Å—Ç–æ–π —Ç–∞–±–ª–∏—Ü–µ.
   - –°–±—Ä–∞—Å—ã–≤–∞—Ç—å —Ä–æ–ª–∏/—Å—Ç–∞—Ç—É—Å—ã –±–µ–∑ –ª–µ–∑–≤–∏—è –≤ –ë–î.
   - **–í–∞–∂–Ω–æ:** –ø–æ–ª–Ω–æ–º–æ—á–∏—è –≤–µ—Ä—Ö–æ–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞ –∏ Dev (—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞) —É—Ä–∞–≤–Ω–µ–Ω—ã: —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –∏–º–µ–µ—Ç —Ç–µ –∂–µ –ø—Ä–∞–≤–∞, —á—Ç–æ –∏ `SUPREME_ADMIN`. –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∑–∞–¥–∞—ë–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `DEV_ADMIN_USERNAME` / `DEV_ADMIN_ID`, —á—Ç–æ–±—ã –±–æ—Ç –ø–æ–Ω–∏–º–∞–ª, –∫—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–º Dev.
4. **–ê—É–¥–∏—Ç.** –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –≤ `admin_action_logs` (—Å–º. ¬ß6).

---

## 3. –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –∏ –º–µ–Ω—é Telegram-–∞–¥–º–∏–Ω–∫–∏

### 3.1 –ö–Ω–æ–ø–∫–∏/–∫–æ–º–∞–Ω–¥—ã
- –ö–Ω–æ–ø–∫–∞ `üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å` –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é –∏–ª–∏ –∫–æ–º–∞–Ω–¥–∞ `/admin`.
- –ö–æ–º–∞–Ω–¥–∞ `/call_lookup <–Ω–æ–º–µ—Ä>` ‚Äî –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –∑–≤–æ–Ω–∫–æ–≤ (—Å–º. ¬ß11-12).
- –ö–æ–º–∞–Ω–¥–∞ `/approve <user_id>` ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è `admin`/`superadmin`).
- –ö–æ–º–∞–Ω–¥–∞ `/make_admin <user_id>` ‚Äî –ø–æ–≤—ã—à–µ–Ω–∏–µ –¥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º; `superadmin` –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã—Ö –∞–¥–º–∏–Ω–æ–≤ ¬´—Å –Ω—É–ª—è¬ª).

### 3.2 –ú–µ–Ω—é
–ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ø–æ–∫–∞–∑—ã–≤–∞–µ–º InlineKeyboard:

| –ö–Ω–æ–ø–∫–∞ | Callback prefix | –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å |
|--------|-----------------|------------------|
| `üìä LIVE Dashboard` | `admin_dashboard` | KPI –∑–∞ —Å–º–µ–Ω—É, –º–µ—Ç—Ä–∏–∫–∏ LM |
| `üë• –û–ø–µ—Ä–∞—Ç–æ—Ä—ã` | `admin_users` | approve/decline/lock, –ø–æ–∏—Å–∫ –ø–æ –§–ò–û/extension |
| `üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã` | `admin_admins` | —Å–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–æ–≤, –ø–æ–≤—ã—à–µ–Ω–∏–µ/–ø–æ–Ω–∏–∂–µ–Ω–∏–µ, –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö |
| `üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞` | `admin_stats` | –∞–≥—Ä–µ–≥–∞—Ç—ã –∏–∑ `metrics_service` |
| `üìÇ –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏` | `admin_lookup` | –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ `/call_lookup` —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π |
| `‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏` | `admin_settings` | –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±–æ—Ç–∞, –∫–∞–Ω–∞–ª—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π |

–í—Å–µ callback-–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –µ–¥–∏–Ω—ã–º —Ä–æ—É—Ç–µ—Ä–æ–º: `CALLBACK_DATA = "<prefix>:<action>:<payload>"`.

---

## 4. –ü–æ—Ç–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ

1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:** –Ω–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞ ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/start`. –í —Ç–∞–±–ª–∏—Ü–µ `users` —Å–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–ø–∏—Å—å —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`.
2. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:** –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å `role in ('admin','superadmin')` –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´–Ω–æ–≤–∞—è –∑–∞—è–≤–∫–∞¬ª —Å –∫–Ω–æ–ø–∫–∞–º–∏ `Approve` / `Decline`.
3. **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:** –ª—é–±–æ–π –∞–¥–º–∏–Ω –Ω–∞–∂–∏–º–∞–µ—Ç `Approve`. –í `users.status` —Å—Ç–∞–≤–∏–º `approved`, –∑–∞–ø–∏—Å—ã–≤–∞–µ–º `approved_by`.
4. **–ü–æ–≤—ã—à–µ–Ω–∏–µ:** –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –≤—Ä—É—á–Ω—É—é –ø–æ–≤—ã—Å–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–æ `admin`. –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `superadmin`), —ç—Ç–æ –º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å –ª–∏–±–æ:
   - `superadmin` —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É `/make_superadmin <user_id>`;
   - –∏–ª–∏ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (`admin_admins` ‚Üí `promote`).
5. **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞:** –ª—é–±–∞—è —Ä–æ–ª—å —Å—Ç–∞—Ä—à–µ (admin / superadmin) –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ `blocked` (–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –≤ –±–æ—Ç).

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –¥–∞–∂–µ –µ—Å–ª–∏ –≤ —Å–∏—Å—Ç–µ–º–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–æ–≤, –∫–∞–∂–¥—ã–π –º–æ–∂–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞. –î–ª—è ¬´bootstrap¬ª —Å—Ü–µ–Ω–∞—Ä–∏—è, –∫–æ–≥–¥–∞ –∞–¥–º–∏–Ω–æ–≤ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `SUPREME_ADMIN_*`, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ env –∏–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—é.

---

## 5. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏

- **–°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–æ–≤** –±–µ—Ä—ë—Ç—Å—è –∏–∑ `users` (—Ñ–∏–ª—å—Ç—Ä `role in ('admin','superadmin')`).
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**:
  - `superadmin` –º–æ–∂–µ—Ç –Ω–∞–∑–Ω–∞—á–∏—Ç—å –ª—é–±–æ–≥–æ `approved` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–æ–º –∏–ª–∏ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–º.
  - –æ–±—ã—á–Ω—ã–π –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ç–æ–ª—å–∫–æ ¬´–æ–±—ã—á–Ω–æ–≥–æ¬ª –∞–¥–º–∏–Ω–∞, –Ω–æ –Ω–µ `superadmin`.
- **–°–Ω—è—Ç–∏–µ –ø–æ–ª–Ω–æ–º–æ—á–∏–π**: –¥–æ—Å—Ç—É–ø–Ω–æ –∞–¥–º–∏–Ω–∞–º –≤—ã—à–µ –ø–æ –∏–µ—Ä–∞—Ä—Ö–∏–∏. –õ–æ–≥–∏–∫–∞: `superadmin` –º–æ–∂–µ—Ç –ø–æ–Ω–∏–∂–∞—Ç—å –≤—Å–µ—Ö; `admin` ‚Äî —Ç–æ–ª—å–∫–æ –¥—Ä—É–≥–∏—Ö –∞–¥–º–∏–Ω–æ–≤ (–Ω–µ —Å—É–ø–µ—Ä-).
- **–®–æ—Ä—Ç–∫–∞—Ç—ã**:
  - `/admins` ‚Äî —Å–ø–∏—Å–æ–∫, inline-–∫–Ω–æ–ø–∫–∏ `Promote`, `Demote`, `Remove`.
  - `/supreme` (—Ç–æ–ª—å–∫–æ `SUPREME_ADMIN`) ‚Äî —Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î.

—É dev - —Å–∞–º—ã–µ –≤—ã—Å–æ–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏, —ç—Ç–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω–æ–≥–æ –ü–û
---

## 6. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –∞—É–¥–∏—Ç

| –°–æ–±—ã—Ç–∏–µ | –ö–æ–≥–æ —É–≤–µ–¥–æ–º–ª—è–µ–º | –ß—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º |
|---------|-----------------|--------------|
| –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –¥–æ—Å—Ç—É–ø | –í—Å–µ `admin`/`superadmin` | `admin_action_logs` (`action='request_created'`) |
| Approve/Decline | –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä –∑–∞—è–≤–∫–∏, –≤—Å–µ –∞–¥–º–∏–Ω—ã | `action='approve'/'decline'`, `actor_id`, `target_id` |
| –ü–æ–≤—ã—à–µ–Ω–∏–µ/–ø–æ–Ω–∏–∂–µ–Ω–∏–µ | –¢–µ–∫—É—â–∏–µ –∞–¥–º–∏–Ω—ã | `action='promote'/'demote'` |
| –í—ã–¥–∞—á–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏/–∞—É–¥–∏–æ | –¢–æ–ª—å–∫–æ –∞—É–¥–∏—Ç | `action='lookup'`, `history_id`, `recording_id` |
| –û—à–∏–±–∫–∏ | `superadmin` + —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞ | Severity –∏–∑ `app/telegram/errors.py` |

`admin_action_logs` –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ –ø—Ä–æ—Å—Ç—É—é —Ç–∞–±–ª–∏—Ü—É `(id, actor_id, target_id, action, payload_json, created_at)`.

---

## 7. –î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –∏ —Å–µ—Ä–≤–∏—Å—ã

| –§—É–Ω–∫—Ü–∏—è | –ò—Å—Ç–æ—á–Ω–∏–∫ |
|---------|----------|
| –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å—Ç–∞—Ç—É—Å—ã | `app/db/repositories/operators.py` + —Ç–∞–±–ª–∏—Ü–∞ `users` |
| –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º | `MetricsService.calculate_operator_metrics` |
| LM-–º–µ—Ç—Ä–∏–∫–∏ per call | `LMRepository.get_lm_values_by_call` |
| –ü–æ–∏—Å–∫ –∑–≤–æ–Ω–∫–æ–≤ | `CallLookupService.lookup_calls` |
| –û—Ç—á—ë—Ç—ã/—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ | `ReportService.generate_report` |

---

## 8. –£–≤—è–∑–∫–∞ —Å call_lookup –∏ —Ç—Ä–µ–±—É–µ–º—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

–í —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ `/call_lookup` —É–º–µ–µ—Ç:
- –∏—Å–∫–∞—Ç—å –∑–≤–æ–Ω–∫–∏ –ø–æ –Ω–æ–º–µ—Ä—É;
- –≤—ã–≤–æ–¥–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å –¥–∞—Ç–æ–π/–≤—Ä–µ–º–µ–Ω–µ–º, ID, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é, —Å–∫–æ—Ä–æ–º;
- –æ—Ç–¥–∞–≤–∞—Ç—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É (`transcript`) –∏ —Å—Å—ã–ª–∫—É –Ω–∞ –∑–∞–ø–∏—Å—å (`record_url`).

–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç:
1. —è–≤–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞ (`patient_number`);
2. `recording_id` (—Ö—Ä–∞–Ω–∏—Ç—å –≤ `call_history`);
3. —Å–≤–æ–¥–∫–∏ LM-–º–µ—Ç—Ä–∏–∫ –¥–ª—è –∑–≤–æ–Ω–∫–∞ (—Å–º. ¬ß12).

–ü–æ—Å–ª–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –≤–∫–ª—é—á–∞—Ç—å: –Ω–æ–º–µ—Ä –ø–∞—Ü–∏–µ–Ω—Ç–∞, –≤—Ä–µ–º—è, —Ç–µ–∫—Å—Ç, –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏, `recording_id`, —Å—Å—ã–ª–∫—É –Ω–∞ –∞—É–¥–∏–æ.

---

## 9. –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∫–∏

1. **–ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î**
   - –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è `role`, `status`, `approved_by`, `blocked_at`, `patient_number`, `recording_id`;
   - —Å–æ–∑–¥–∞—Ç—å `admin_action_logs`.
2. **PermissionsManager**
   - –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –Ω–∞ —Ä–æ–ª–∏/—Å—Ç–∞—Ç—É—Å—ã (–±–µ–∑ —Ö–∞—Ä–¥–∫–æ–¥–∞ username);
   - –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `is_superadmin`.
3. **Admin panel handlers**
   - `/admin` + InlineKeyboard (—Å–º. ¬ß3.2);
   - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ `admin_users`, `admin_admins`, `admin_stats`, `admin_lookup`.
4. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –∞—É–¥–∏—Ç** (—Å–º. ¬ß6).
5. **Call lookup —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ** (—Å–º. ¬ß11-12).
6. **–ö–æ–º–∞–Ω–¥—ã –±—ã—Å—Ç—Ä–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è** (`/approve`, `/make_admin`, `/admins`).

---

## 10. –°–≤—è–∑—å —Å –±–∞–∑–æ–π –∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏

- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ–≤–µ—Ä—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ `DatabaseManager` (`app/db/manager.py`).
- –ê–¥–º–∏–Ω—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ (approve/promote) –≤—ã–∑—ã–≤–∞—é—Ç `OperatorRepository` –∏–ª–∏ –Ω–æ–≤—ã–π `AdminRepository`.
- –ú–µ—Ç—Ä–∏–∫–∏ –∏ –æ—Ç—á—ë—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `MetricsService`, `LMService`, `ReportService`.
- Call lookup –∏ –≤—ã–¥–∞—á–∞ –∞—É–¥–∏–æ ‚Äî `CallLookupService` (—Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏).

---

## 11. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è –≤—ã–¥–∞—á–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏

_–ê–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–º. –∫–æ–¥ `app/services/call_lookup.py` –∏ `app/telegram/handlers/call_lookup.py`._

- `/call_lookup` —É–∂–µ –≤—ã–¥–∞—ë—Ç —Å–ø–∏—Å–æ–∫ –∑–≤–æ–Ω–∫–æ–≤ (–¥–∞—Ç–∞/–≤—Ä–µ–º—è, —É—á–∞—Å—Ç–Ω–∏–∫–∏, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, `history_id`, `score`).
- –ö–Ω–æ–ø–∫–∏ ¬´–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞¬ª –∏ ¬´–ó–∞–ø–∏—Å—å¬ª –¥–µ—Ä–≥–∞—é—Ç `fetch_call_details`.
- –ù–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π `patient_number` –∏ `recording_id`; LM-–º–µ—Ç—Ä–∏–∫–∏ –Ω–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è.

**–ü—Ä–æ–±–µ–ª—ã –ø—Ä–æ—Ç–∏–≤ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π:**

1. –ù–æ–º–µ—Ä –ø–∞—Ü–∏–µ–Ω—Ç–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ `caller_info`/`caller_number`.
2. –î–∞—Ç–∞/–≤—Ä–µ–º—è –Ω—É–∂–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤ –∏—Ç–æ–≥–æ–≤–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ.
3. –ú–µ—Ç—Ä–∏–∫–∏/—Å–≤–æ–¥–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.
4. `recording_id` –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è.

---

## 12. –ü—Ä–æ–µ–∫—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è call_lookup

### 12.1 –°—Ö–µ–º–∞/–º–æ–¥–µ–ª–∏
- –í `call_history` –¥–æ–±–∞–≤–∏—Ç—å `patient_number`, `recording_id`.
- –û–±–Ω–æ–≤–∏—Ç—å `CallHistoryRecord`, `CallLookupResult`, DTO –≤ —Ö–µ–Ω–¥–ª–µ—Ä–∞—Ö.

### 12.2 –°–µ—Ä–≤–∏—Å
1. –†–∞—Å—à–∏—Ä–∏—Ç—å SQL –≤ `lookup_calls`/`fetch_call_details` (–ø–æ–ª—É—á–∞—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è).
2. –ü–æ–¥—Ç—è–≥–∏–≤–∞—Ç—å LM-–º–µ—Ç—Ä–∏–∫–∏:
   ```python
   lm_metrics = await self.lm_repo.get_lm_values_by_call(history_id)
   ```
3. –§–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å JSON-–æ—Ç–≤–µ—Ç —Å –∫–ª—é—á–µ–≤—ã–º–∏ –ø–æ–ª—è–º–∏:
   ```json
   {
     "patient_number": "...",
     "call_time": "...",
     "transcript": "...",
     "recording_id": "...",
     "record_url": "...",
     "lm_metrics": [...]
   }
   ```

### 12.3 Telegram-—Ö–µ–Ω–¥–ª–µ—Ä
- –í —Å–ø–∏—Å–∫–µ –∑–≤–æ–Ω–∫–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞.
- –í –æ—Ç–≤–µ—Ç–µ –Ω–∞ ¬´–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞¬ª –≤—ã–≤–æ–¥–∏—Ç—å –ø–æ–ª–Ω—ã–π –±–ª–æ–∫:
  ```
  –ü–∞—Ü–∏–µ–Ω—Ç: XXX
  –í—Ä–µ–º—è: 12.04 14:32
  –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞: ...
  –ú–µ—Ç—Ä–∏–∫–∏: response_speed=85, conversion_score=50, ...
  recording_id: abc123
  üéß https://...
  ```
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ ¬´üìä –ú–µ—Ç—Ä–∏–∫–∏¬ª.

### 12.4 –ê—É–¥–∏—Ç –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –ó–∞–ø–∏—Å—ã–≤–∞—Ç—å –≤ `call_access_logs` –Ω–µ —Ç–æ–ª—å–∫–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –Ω–æ –∏ `history_id`, `recording_id`.
- –î–ª—è –≤—ã–¥–∞—á–∏ –∑–∞–ø–∏—Å–∏/–º–µ—Ç—Ä–∏–∫ —É–≤–µ–¥–æ–º–ª—è—Ç—å only if —Ç—Ä–µ–±—É–µ—Ç—Å—è (–ø–æ –ø–æ–ª–∏—Ç–∏–∫–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏).

---

## 13. –ü–µ—Ä–µ–Ω–æ—Å–∏–º—ã–µ –∏–¥–µ–∏ –∏–∑ ¬´—á—É–∂–æ–π¬ª –∞–¥–º–∏–Ω–∫–∏

1. **–ï–¥–∏–Ω—ã–π –≤—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å** (–∫–Ω–æ–ø–∫–∞, –º–µ–Ω—é) ‚Äî –≤–Ω–µ–¥—Ä—è–µ–º.
2. **–†–æ–ª–µ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏** ‚Äî —É–∂–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã (—Ä–æ–ª—å/—Å—Ç–∞—Ç—É—Å –≤ `users`).
3. **Callback-–ø—Ä–µ—Ñ–∏–∫—Å—ã** ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `admin_*`, `user_*`, `dashboard_*`.
4. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏** ‚Äî approve/decline/promote –ø—Ä—è–º–æ –∏–∑ Telegram —á–µ—Ä–µ–∑ inline-–∫–Ω–æ–ø–∫–∏.
5. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è/–∞—É–¥–∏—Ç** ‚Äî –ª–æ–≥–∏ + —Ä–∞—Å—Å—ã–ª–∫–∏.
6. **–í–µ–±-–ø–æ–¥–¥–µ—Ä–∂–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)** ‚Äî –µ—Å–ª–∏ –∫–æ–≥–¥–∞-–ª–∏–±–æ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –∏–ª–∏ –¥–ª–∏–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç—ã, –º–æ–∂–Ω–æ –ø–æ–¥–Ω—è—Ç—å –ø—Ä–æ—Å—Ç–æ–π Flask-—Å–µ—Ä–≤–∏—Å (–±–µ–∑ QR-—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞).
7. **–°–∏—Å—Ç–µ–º–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** ‚Äî –±–ª–æ–∫ `admin_stats`, –∫–æ—Ç–æ—Ä—ã–π –¥–µ—Ä–≥–∞–µ—Ç `MetricsService`.

–≠—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç—ã –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ –Ω–∞—à —Å—Ç–µ–∫: –¥–∞–Ω–Ω—ã–µ –∏–∑ `users`, —Å–µ—Ä–≤–∏—Å—ã `app/services/*`, –º–µ—Ç—Ä–∏–∫–∏ –∏–∑ LM.
